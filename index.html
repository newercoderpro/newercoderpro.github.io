<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Inside Browser</title>
<style>
html, body { margin:0; height:100%; font-family:Arial,sans-serif; }
#tabBar { display:flex; gap:4px; padding:4px 8px; background:#ddd; border-bottom:1px solid #ccc; position:fixed; top:0; left:0; width:100%; z-index:20; overflow-x:auto; }
.tab { padding:6px 12px; background:#eee; border-radius:4px 4px 0 0; cursor:pointer; display:flex; align-items:center; gap:4px; flex-shrink:0; }
.tab.active { background:#fff; font-weight:bold; border-bottom:2px solid #2196F3; }
.tab button.closeTab { background:transparent; border:none; cursor:pointer; font-weight:bold; font-size:14px; }
#toolbar { display:flex; align-items:center; gap:8px; padding:8px; background:#f1f3f4; border-bottom:1px solid #ccc; position:fixed; top:32px; width:100%; left:0; z-index:10; }
#toolbar button { font-size:16px; padding:6px 10px; cursor:pointer; }
#address { flex:1; padding:8px 12px; border-radius:16px; border:1px solid #ccc; font-size:14px; }
#iframeContainer { position:absolute; top:80px; bottom:0; left:0; right:0; }
#contentFrame { width:100%; height:100%; border:none; }
</style>
</head>
<body>

<div id="tabBar"></div>

<div id="toolbar">
  <button onclick="goBack()">‚¨Ö</button>
  <button onclick="refreshPage()">üîÑ</button>
  <button onclick="goHome()">üè†</button>
  <input id="address" value="" onkeydown="if(event.key==='Enter'){goToURL()}" />
  <button onclick="goToURL()">Go</button>
  <button onclick="createNewTab()">Ôºã</button>
</div>

<div id="iframeContainer">
  <iframe id="contentFrame" src=""></iframe>
</div>

<script>
/* ----------------- SETTINGS ----------------- */
const maxTabs = 10;
const homeURL = "lan://pw.home.fun";

/* ----------------- STATE ----------------- */
let tabs = [];
let activeTabIndex = 0;
let currentURL = "";

/* ----------------- STORAGE ----------------- */
function saveTabs() {
  localStorage.setItem("tabsData", JSON.stringify({ tabs, activeTabIndex }));
}

function loadTabs() {
  try {
    const saved = JSON.parse(localStorage.getItem("tabsData"));
    if(saved && saved.tabs && saved.tabs.length>0) {
      tabs = saved.tabs;
      activeTabIndex = saved.activeTabIndex || 0;
      if(activeTabIndex >= tabs.length) activeTabIndex = 0;
    } else {
      tabs = [{ name:"Home", url:homeURL, history:[] }];
      activeTabIndex = 0;
    }
  } catch(e) {
    tabs = [{ name:"Home", url:homeURL, history:[] }];
    activeTabIndex = 0;
  }
  renderTabs();
  switchTab(activeTabIndex,false); // initial load, don't save yet
}

/* ----------------- TAB FUNCTIONS ----------------- */
function renderTabs() {
  const tabBar = document.getElementById("tabBar");
  tabBar.innerHTML = "";
  tabs.forEach((tab,i)=>{
    const el = document.createElement("div");
    el.className = "tab" + (i===activeTabIndex ? " active" : "");
    el.textContent = tab.name;
    const closeBtn = document.createElement("button");
    closeBtn.className = "closeTab";
    closeBtn.textContent = "√ó";
    closeBtn.onclick = (e)=>{ e.stopPropagation(); closeTab(i); };
    el.appendChild(closeBtn);
    el.onclick = ()=>switchTab(i);
    tabBar.appendChild(el);
  });
  saveTabs();
}

function switchTab(index, save=true) {
  activeTabIndex = index;
  const tab = tabs[index];
  document.getElementById("address").value = tab.url;
  loadURL(mapURL(tab.url));
  renderTabs();
  if(save) saveTabs();
}

function createNewTab() { addTab("New Tab", homeURL); }

function addTab(name,url){
  if(tabs.length >= maxTabs){ alert("Maximum 10 tabs!"); return; }
  tabs.push({ name,url, history:[] });
  switchTab(tabs.length-1);
}

function closeTab(index){
  if(tabs.length===1) return;
  tabs.splice(index,1);
  if(activeTabIndex>=index) activeTabIndex = Math.max(0,activeTabIndex-1);
  switchTab(activeTabIndex);
}

/* ----------------- URL MAPPING ----------------- */
function mapURL(url){
  if(url.startsWith("lan://pw.")){
    const page = url.replace("lan://pw.","").replace(".fun","");
    return "pages/"+page+".html";
  }
  return url;
}

/* ----------------- IFRAME / BROWSER ----------------- */
function loadURL(url){ 
  currentURL = url; 
  document.getElementById("contentFrame").src = url;
}

function goToURL(){
  const raw = document.getElementById("address").value.trim();
  if(!raw) return;
  tabs[activeTabIndex].url = raw;
  renderTabs();
  tabs[activeTabIndex].history.push(currentURL);
  loadURL(mapURL(raw));
  saveTabs();
}

function goBack(){
  const hist = tabs[activeTabIndex].history;
  if(hist.length>0){
    const last = hist.pop();
    tabs[activeTabIndex].url = last;
    document.getElementById("address").value = last;
    loadURL(mapURL(last));
    renderTabs();
    saveTabs();
  }
}

function refreshPage(){ loadURL(mapURL(tabs[activeTabIndex].url)); }

function goHome(){
  tabs[activeTabIndex].url = homeURL;
  document.getElementById("address").value = homeURL;
  renderTabs();
  loadURL(mapURL(homeURL));
  saveTabs();
}

  // AUTO-NAME TABS BASED ON PAGE TITLE OR FIRST H1
document.getElementById("contentFrame").onload = function() {
  try {
    const iframeDoc = document.getElementById("contentFrame").contentDocument;
    if(!iframeDoc) return;

    // Try title first
    let newName = iframeDoc.title;
    
    // If no title, fallback to first H1
    if(!newName || newName.trim() === "") {
      const h1 = iframeDoc.querySelector("h1");
      if(h1) newName = h1.textContent.trim();
    }

    // If still empty, fallback to URL
    if(!newName || newName.trim()==="") {
      newName = tabs[activeTabIndex].url;
    }

    tabs[activeTabIndex].name = newName;
    renderTabs();
  } catch(e) {
    // Cross-origin pages can't be accessed
    // fallback to URL
    tabs[activeTabIndex].name = tabs[activeTabIndex].url;
    renderTabs();
  }
}

/* ----------------- INITIAL LOAD ----------------- */
loadTabs();
</script>

</body>
</html>
